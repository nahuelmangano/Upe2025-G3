name: CI/CD Monorepo (frontend & backend)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

concurrency:
  group: deploy-monorepo
  cancel-in-progress: true

jobs:
  filter:
    name: Detectar cambios
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'FRONTEND/**'
            backend:
              - 'BACKEND/**'

  build-frontend:
    name: Build & Push Frontend
    needs: filter
    if: needs.filter.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (frontend)
        uses: docker/build-push-action@v6
        with:
          context: ./FRONTEND
          file: ./FRONTEND/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/upe2025-frontend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/upe2025-frontend:${{ github.sha }}

  build-backend:
    name: Build & Push Backend
    needs: filter
    if: needs.filter.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (backend)
        uses: docker/build-push-action@v6
        with:
          context: ./BACKEND
          file: ./BACKEND/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/upe2025-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/upe2025-backend:${{ github.sha }}

  deploy:
  name: Deploy en VPS
  needs: [filter, build-frontend, build-backend]
  if: ${{ always() && (needs.filter.outputs.frontend == 'true' || needs.filter.outputs.backend == 'true') }}
  runs-on: ubuntu-latest
  steps:
    - name: Preparar known_hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Deploy por SSH
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          cd /opt/upe/compose
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

          SERVICES=""
          if [ "${{ needs.filter.outputs.frontend }}" = "true" ]; then SERVICES="$SERVICES frontend"; fi
          if [ "${{ needs.filter.outputs.backend }}" = "true" ]; then SERVICES="$SERVICES backend"; fi

          echo "Actualizando servicios: $SERVICES"
          docker compose pull $SERVICES
          docker compose up -d $SERVICES
          docker image prune -f

