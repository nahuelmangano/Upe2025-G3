<div class="card" style="margin-bottom:12px">
      <h3 class="h3" style="margin-bottom:12px">Evoluciones</h3>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px">
        <button class="btn" type="button" (click)="openModal()">+ Nueva Evolucion</button>
        <input [(ngModel)]="q" placeholder="Buscar..." style="flex:1" />
      </div>

      <div *ngIf="loading">Cargando evoluciones...</div>
      <div *ngIf="error" style="color:#d63031">{{ error }}</div>

      <ng-container *ngIf="!loading && !error">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Problema</th>
                <th>Diagnostico Inicial</th>
                <th>Diagnostico Final</th>
                <th>Medico</th>
                <th>Estado</th>
                <th>Planilla</th>
                <th>Estudios</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let e of pageItems()">
              <tr>
                <td>{{ e.problema }}</td>
                <td>{{ e.diagnosticoInicial }}</td>
                <td>{{ e.diagnosticoFinal }}</td>
                <td>{{ e.medico }}</td>
                <td>{{ e.estado }}</td>
                <td>
                  <button *ngIf="e.tienePlanilla" class="btn-outline" style="padding:4px 10px;font-size:12px"
                    type="button" (click)="togglePlanilla(e)">
                    {{ e.mostrarPlanilla ? 'Ocultar' : 'Ver' }}
                  </button>
                  <span *ngIf="!e.tienePlanilla" style="font-size:12px;color:#6b7280">Sin plantilla</span>
                </td>
                <td>
                  <a (click)="openEstudios(e)" title="Ver estudios" style="cursor:pointer;color:#4b5563;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                      <path d="M14 2v6h6" />
                    </svg>
                  </a>
                </td>
                <td>
                  <div style="display:flex;gap:10px;align-items:center">
                    <a (click)="openEdit(e)" title="Editar" style="cursor:pointer;color:#4b5563">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                    </a>
                  </div>
                </td>
              </tr>
              <tr *ngIf="e.mostrarPlanilla && e.tienePlanilla" class="planilla-row visible">
                  <td colspan="8" style="background:#f9fafb;padding:16px 18px;border-top:1px solid #e5e7eb">
                    <div style="background:#ffffff;border-radius:16px;padding:18px;box-shadow:0 10px 24px rgba(15,23,42,0.08);display:flex;flex-direction:column;gap:14px">
                      <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="display:flex;flex-direction:column;gap:6px">
                          <span style="font-weight:700;color:#111827;font-size:16px">Planilla utilizada</span>
                          <span style="color:#4b5563;font-size:13px">Plantilla: {{ e.plantillaNombre || ('#' + e.plantillaId) }}</span>
                        </div>
                        <button class="btn-outline" type="button" (click)="togglePlanilla(e)">Cerrar</button>
                      </div>
                      <div *ngIf="e.planillaLoading" style="font-size:13px;color:#4b5563">Cargando datos de la planilla...</div>
                      <div *ngIf="e.planillaError" style="font-size:13px;color:#b91c1c">{{ e.planillaError }}</div>
                      <ng-container *ngIf="!e.planillaLoading && !e.planillaError">
                        <div *ngIf="!e.planillaCampos?.length" style="font-size:13px;color:#6b7280">No se registraron valores para esta planilla.</div>
                        <div *ngIf="e.planillaCampos?.length" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;">
                          <div *ngFor="let campo of e.planillaCampos" style="border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:linear-gradient(145deg,rgba(249,250,251,1) 0%,rgba(255,255,255,1) 100%);">
                            <div style="font-size:12px;color:#6366f1;text-transform:uppercase;letter-spacing:0.04em;font-weight:600;">{{ campo.etiqueta }}</div>
                            <div style="margin-top:6px;font-size:14px;color:#111827;white-space:pre-wrap">{{ formatPlanillaValor(campo.valor) }}</div>
                          </div>
                        </div>
                      </ng-container>
                    </div>
                  </td>
              </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px">
          <div style="display:flex; gap:8px; align-items:center">
            <small>Items per page:</small>
            <select [(ngModel)]="pageSize">
              <option [ngValue]="5">5</option>
              <option [ngValue]="10">10</option>
            </select>
          </div>
          <div style="display:flex; gap:10px; align-items:center">
            <small>{{ rangeLabel() }}</small>
            <button class="btn-outline" (click)="prev()" [disabled]="page===0"><</button>
            <button class="btn-outline" (click)="next()" [disabled]="(page+1)>=pagesCount()">></button>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Modal crear/editar -->
    <div *ngIf="modalOpen" class="modal-backdrop">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 class="h3" style="margin:0">{{ editId ? 'Editar Evolucion' : 'Nueva Evolucion' }}</h3>
          <button class="btn-outline" type="button" (click)="closeModal()">x</button>
        </div>

        <form (ngSubmit)="save()" #evoForm="ngForm" style="display:grid;gap:12px">
          <div class="modal-grid">
            <label>
              <span>Fecha de consulta</span>
              <input type="date" required [(ngModel)]="fecha" name="fecha" />
            </label>
            <label class="full">
              <span>Diagnostico Inicial</span>
              <input required [(ngModel)]="form.diagnosticoInicial" name="diagnosticoInicial" />
            </label>
            <label class="full">
              <span>Diagnostico Final</span>
              <input [(ngModel)]="form.diagnosticoDefinitivo" name="diagnosticoDefinitivo" />
            </label>
            <label class="full">
              <span>Descripcion</span>
              <textarea rows="4" [(ngModel)]="form.descripcion" name="descripcion"></textarea>
            </label>
            <label class="full">
              <span>Estado del problema</span>
              <select [(ngModel)]="editEstadoId" name="estadoProblema">
                <option *ngFor="let est of estadoOptions" [ngValue]="est.id">{{ est.nombre }}</option>
              </select>
            </label>
          </div>

          <div *ngIf="modalError" style="color:#d63031">{{ modalError }}</div>

          <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn-outline" type="button" (click)="closeModal()">Cancelar</button>
            <button class="btn" type="submit" [disabled]="saving || evoForm.invalid">
              {{ saving ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal estudios por evolución -->
    <div *ngIf="estudiosModal" class="modal-backdrop">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 class="h3" style="margin:0">Estudios</h3>
          <button class="btn-outline" type="button" (click)="closeEstudios()">x</button>
        </div>
        <div *ngIf="estudiosLoading">Cargando estudios...</div>
        <div *ngIf="!estudiosLoading">
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Archivo</th>
                  <th>Tamaño</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of estudios">
                  <td>{{ s.nombre }}</td>
                  <td>{{ s.tamano | number }} bytes</td>
                  <td>
                    <a [href]="archivoSrv.descargar(s.id)" title="Descargar" target="_blank">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <path d="M7 10l5 5 5-5"/>
                        <path d="M12 15V3"/>
                      </svg>
                    </a>
                  </td>
                </tr>
                <tr *ngIf="estudios.length===0"><td colspan="3">Sin archivos</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  
