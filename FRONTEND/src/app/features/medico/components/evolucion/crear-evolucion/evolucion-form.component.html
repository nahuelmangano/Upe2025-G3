<div class="card">
  <h3 class="h3" style="margin-bottom:12px">Evolucion</h3>
  <div class="form-content">
    <div class="modal-grid form-grid">
      <label class="fecha-hora-field" style="grid-column:1/4">
        <span>Fecha y hora</span>
        <div class="fecha-hora-input">
          <input
            #fechaHoraInput
            type="datetime-local"
            [(ngModel)]="fechaHora"
            name="fechaHora"
            [max]="fechaMaxima"
            (focus)="onFechaHoraFocus()"
            (change)="onFechaHoraChange()"
            (input)="onFechaHoraInput()"
          />
          <button type="button" class="seleccionar-fecha-btn" (click)="confirmarFechaHora()">Seleccionar</button>
        </div>
      </label>

      <div class="problema-row" style="grid-column:1/4">
        <label class="problema-field">
          <span>Problema</span>
          <select
            [(ngModel)]="selectedProblemaId"
            name="problemaId"
            (ngModelChange)="onProblemaIdChange($event)"
          >
            <option [ngValue]="null">Seleccione un problema</option>
            <option *ngFor="let pr of problemas" [ngValue]="pr.id">{{ pr.titulo }}</option>
          </select>
        </label>
        <button class="btn btn-problema" type="button" (click)="nuevoProblema()">+ Problema</button>
      </div>
      <div class="estado-field-wrapper" style="grid-column:1/4">
        <label class="estado-field">
          <span>Estado del problema</span>
          <select [(ngModel)]="estadoProblemaId" name="estadoProblemaId">
            <option *ngFor="let e of estados" [ngValue]="e.id">{{ e.nombre }}</option>
          </select>
        </label>
      </div>

      <label class="plantilla-field" style="grid-column:1/4">
        <span>Plantillas</span>
        <select [(ngModel)]="plantillaId" (change)="applyTemplate()" name="plantillaId">
          <option [ngValue]="undefined">Seleccione</option>
          <option [ngValue]="null">Vacío</option>
          <option *ngFor="let t of plantillas" [ngValue]="t.id">
            {{ t.nombre || ('Plantilla ' + t.id) }}
          </option>
        </select>
      </label>

      <div style="grid-column:1/7" *ngIf="previewLoading">
        <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:14px">
          <strong>Previsualización</strong>
          <p style="margin:8px 0 0;font-size:13px;color:#4b5563">Cargando plantilla…</p>
        </div>
      </div>

      <div style="grid-column:1/7" *ngIf="previewError && !previewLoading">
        <div style="background:#fdf2f2;border:1px solid #fecaca;border-radius:8px;padding:14px">
          <strong>Previsualización</strong>
          <p style="margin:8px 0 0;font-size:13px;color:#b91c1c">{{ previewError }}</p>
        </div>
      </div>

      <div class="plantilla-preview" *ngIf="plantillaPreview && !previewLoading">
        <div class="preview-card">
          <div *ngIf="!plantillaPreview.secciones.length" class="preview-empty">
            Esta plantilla no tiene campos definidos todavía.
          </div>
          <ng-container *ngFor="let seccion of plantillaPreview.secciones">
            <div class="preview-section">
              <div class="preview-section-pill">
                <span class="preview-pill-label">Sección</span>
                <span class="preview-pill-title">{{ seccion.titulo || 'Sin título' }}</span>
              </div>
              <div class="preview-grid">
                <ng-container *ngFor="let campo of seccion.campos">
                  <div class="preview-field">
                    <span class="preview-field-label">{{ campo.etiqueta }}</span>
                    <ng-container [ngSwitch]="campo.tipoEntrada">
                      <input
                        *ngSwitchCase="'text'"
                        class="preview-control"
                        type="text"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <textarea
                        *ngSwitchCase="'textarea'"
                        class="preview-control preview-control--textarea"
                        rows="3"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      ></textarea>
                      <input
                        *ngSwitchCase="'number'"
                        class="preview-control"
                        type="number"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <input
                        *ngSwitchCase="'decimal'"
                        class="preview-control"
                        type="number"
                        step="0.01"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <input
                        *ngSwitchCase="'datetime-local'"
                        class="preview-control"
                        type="datetime-local"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <select
                        *ngSwitchCase="'select'"
                        class="preview-control preview-control--select"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      >
                        <option [ngValue]="''">Seleccione</option>
                        <option *ngFor="let opt of (campo.opciones || [])" [ngValue]="opt">{{ opt }}</option>
                      </select>
                      <select
                        *ngSwitchCase="'multiselect'"
                        class="preview-control preview-control--multi"
                        multiple
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      >
                        <option *ngFor="let opt of (campo.opciones || [])" [ngValue]="opt">{{ opt }}</option>
                      </select>
                      <label *ngSwitchCase="'checkbox'" class="preview-checkbox">
                        <input type="checkbox" [(ngModel)]="campo.valor" [ngModelOptions]="{standalone:true}" />
                        <span>{{ campo.valor ? 'Seleccionado' : 'No seleccionado' }}</span>
                      </label>
                      <input
                        *ngSwitchCase="'file'"
                        class="preview-control preview-control--file"
                        type="file"
                        disabled
                      />
                      <input
                        *ngSwitchCase="'email'"
                        class="preview-control"
                        type="email"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <input
                        *ngSwitchCase="'tel'"
                        class="preview-control"
                        type="tel"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                      <input
                        *ngSwitchDefault
                        class="preview-control"
                        type="text"
                        [(ngModel)]="campo.valor"
                        [ngModelOptions]="{standalone:true}"
                      />
                    </ng-container>
                  </div>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <div style="grid-column:1/7">
        <span style="display:block;margin-bottom:6px;color:#374151;font-size:14px">Diagnostico Inicial</span>
        <textarea rows="12" [(ngModel)]="texto" placeholder="Ingrese aqui una evolucion..."></textarea>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <div></div>
      <div style="display:flex;gap:10px">
        <button class="btn-outline" type="button" (click)="clear()">Limpiar</button>
        <button class="btn" type="button" (click)="guardar()">Guardar</button>
      </div>
    </div>

    <div style="text-align:right;margin-top:8px">
      <small>Evolucionado por <strong>{{ currentMedicoNombre() }}</strong></small>
    </div>
  </div>
</div>
